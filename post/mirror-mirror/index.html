<!DOCTYPE html>
<html lang="en-US">
<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mirror Mirror on ...</title>

    <meta name="description" content="Of Mice (Unsafe) and Men (Reflect)">

    <meta property="site_name" content="recency-bias">
    <meta property="og:type" content="article">
    <meta property="og:url" content="http://badu.github.io/post/mirror-mirror/">
    <meta property="og:title" content="Mirror Mirror on ...">
    <meta property="og:image" content="">

    <meta property="og:description" content="Of Mice (Unsafe) and Men (Reflect)">

    <meta name="twitter:url" content="http://badu.github.io/post/mirror-mirror/">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@recency-bias">
    <meta name="twitter:creator" content="@recency-bias">
    <meta name="twitter:title" content="Mirror Mirror on ...">
    <meta name="twitter:img:src" content="">

    <meta name="twitter:label1" content="Author">
    <meta name="twitter:data1" content="Bogdan Dinu">
    <meta name="twitter:label2" content="Published On">
    <meta name="twitter:data2" content="March 10, 2018">


    <link rel="dns-prefetch" href="//www.google-analytics.com">
    <link rel="dns-prefetch" href="//stats.g.doubleclick.net">

    <link rel="canonical" href="http://badu.github.io/post/mirror-mirror/">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico">
    <link rel="shortcut icon" href="http://badu.github.io/favicon.ico">

<style>
    html body {
        font-family: 'Roboto', sans-serif;
        background-color: white;
    }

    :root {
        --accent: #00bcd4;
        --border-width:  5px ;
    }
</style>


<link rel="stylesheet" href="/css/main.css">





<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">



<link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/solarized-dark.min.css"> 


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
      integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
      integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
 

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script> 
    <script>hljs.initHighlightingOnLoad();</script>




<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
        integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"></script>

<script>$(document).on('click', function() { $('.collapse').collapse('hide'); })</script> <meta name="generator" content="Hugo 0.63.0-DEV" />



    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-687869-6"></script>
    <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments)};
          gtag('js', new Date());

          gtag('config', 'UA-687869-6');
          (function() {
          function ready(cb) {
              /in/.test(document.readyState) 
                      ? setTimeout(ready.bind(null, cb), 9)
                      : cb();
          }
          ready(function() {
              
              var indicator = document.querySelector('.scroll-progress');
              if (indicator) {
                  document.addEventListener('scroll', function (e) {
                      var dh = document.body.scrollHeight;
                      var wh = window.innerHeight;
                      var pos = window.scrollY;
                      var footerHeight = 50;
                      var perc = pos / (dh - footerHeight - wh) * 100;
                      indicator.style.setProperty('--scale', (perc / 100));
                  })
              }
              
              var links = document.links;
              for (var i = 0, linksLength = links.length; i < linksLength; i++) {
                  if (links[i].hostname != window.location.hostname) {
                      links[i].target = '_blank';
                  }
              }
          });
          }());
    </script>

</head>

<body>

<nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
        <div class="navbar-header">
            <a class="navbar-brand visible-xs" href="#">Mirror Mirror on ...</a>
            <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
        </div>
        <div class="collapse navbar-collapse">
        
            <ul class="nav navbar-nav">
            
                <li><a href="/post/">Posts</a></li>
            
                <li><a href="/about/">About</a></li>
            
                <li><a href="/why-recency-bias/">Why Recency Bias?</a></li>
            
            </ul>
        

        
            <ul class="nav navbar-nav navbar-right">
            
                <li class="navbar-icon"><a href="mailto:badu@badu.ro"><i class="fa fa-envelope-o"></i></a></li>
            
                <li class="navbar-icon"><a href="https://github.com/badu/"><i class="fa fa-github"></i></a></li>
            
                <li class="navbar-icon"><a href="https://twitter.com/baduro/"><i class="fa fa-twitter"></i></a></li>
            
                <li class="navbar-icon"><a href="https://www.linkedin.com/in/golangdeveloper/"><i class="fa fa-linkedin"></i></a></li>
            
                <li>
                    <script type="text/javascript" src="https://secure.skypeassets.com/i/scom/js/skype-uri.js"></script>
                    <div id="SkypeButton_Call_badu.bogdan_1">
                        <script type="text/javascript">
                                         Skype.ui({
                                         "name": "chat",
                                         "element": "SkypeButton_Call_badu.bogdan_1",
                                         "participants": ["badu.bogdan"]
                                         });
                        </script>
                    </div>
                </li>
            </ul>
        

        </div>

    </div>
    
    <div class="scroll-progress"></div>
</nav>
<main>
<div class="item">



  
    <h4><a href="/post/mirror-mirror/">Mirror Mirror on ...</a></h4>
    <h5>Of Mice (Unsafe) and Men (Reflect)</h5>
    
      <h5>Published on March 10, 2018</h5>
    
 <kbd class="item-tag">Go</kbd>  <kbd class="item-tag">Advanced</kbd>  <kbd class="item-tag">Reflect</kbd>  <kbd class="item-tag">Unsafe</kbd> 
<p>About 12 minutes of reading.</p>
</div>

    <br>
    <div class="text-justify"><h4 id="tldr">TL;DR</h4>
<p>While I was mentoring, I encouraged my pupils to break things so they understand how they work. Using reflect package seems easy, but understanding the mechanics is hard. So, this week, following my own advice, I've tried to create my own reflect package. Here is what I've learned.</p>
<h4 id="playing-with-fire">Playing with Fire</h4>
<p>Most of the articles on the subject I've read have (more or less) the following advice : &ldquo;if you find yourself doing this in a real program, stop immediately and seek help. You are doing something wrong. Youâ€™ve been warned!&quot;. Now, wait a minute, mister. That is hypocrisy!</p>
<p>If you take a look at the importers of <a href="https://godoc.org/reflect?importers">reflect</a> you will easily find that using the <code>fmt</code> implies you are using reflect. Using &ldquo;unsafe&rdquo; features in Golang is only for developers that develop the language itself? Maybe looking on importers of <a href="https://godoc.org/unsafe?importers">unsafe</a> tells you otherwise.</p>
<h4 id="unsafe---after-that-we-reflect"><code>unsafe</code> - after that we <code>reflect</code></h4>
<p>I quote from the documentation : &ldquo;unsafe.Pointer type  allows a program to defeat the type system and read and write arbitrary memory. It should be used with extreme care&rdquo;.</p>
<p>Let's say you have type <code>John</code> which you are trying to convert to type <code>Ivan</code>. The documentation states that Ivan has to be smaller or equal with John (in terms of properties it has) and those to share the `equivalent memory layout.</p>
<p>Let's code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestIsJohnIvan</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">John</span> <span style="color:#66d9ef">struct</span> {
		<span style="color:#a6e22e">Name</span>   <span style="color:#66d9ef">string</span>
		<span style="color:#a6e22e">Age</span>    <span style="color:#66d9ef">uint</span>
		<span style="color:#a6e22e">Powers</span> <span style="color:#66d9ef">uint</span>
	}

	<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Ivan</span> <span style="color:#66d9ef">struct</span> {
		<span style="color:#a6e22e">givenName</span>  <span style="color:#66d9ef">string</span> <span style="color:#75715e">// yes, you can use private fields
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">_</span>          <span style="color:#66d9ef">uint</span>
		<span style="color:#a6e22e">ThirdField</span> <span style="color:#66d9ef">uint</span>
	}

	<span style="color:#a6e22e">john</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">John</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;John&#34;</span>, <span style="color:#a6e22e">Age</span>: <span style="color:#ae81ff">40</span>, <span style="color:#a6e22e">Powers</span>: <span style="color:#ae81ff">3</span>}

	<span style="color:#a6e22e">ivan</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">*</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">Ivan</span>)(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">john</span>))
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Logf</span>(<span style="color:#e6db74">&#34;John as Ivan : GivenName %v ThirdField %d&#34;</span>, <span style="color:#a6e22e">ivan</span>.<span style="color:#a6e22e">givenName</span>, <span style="color:#a6e22e">ivan</span>.<span style="color:#a6e22e">ThirdField</span>)
}
</code></pre></div><p>First observation is that you can violate access to private fields using this conversion. Secondly, as long as you respect the same number of fields and their types, you can omit properties. You can violate the second rule and get unexpected results, as below:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">	<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ShortIvan</span> <span style="color:#66d9ef">struct</span> {
		<span style="color:#a6e22e">Age</span> <span style="color:#66d9ef">uint</span>
	}
	<span style="color:#a6e22e">smallIvan</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">*</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">ShortIvan</span>)(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">john</span>))
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Logf</span>(<span style="color:#e6db74">&#34;Small Ivan (just powers) : %v&#34;</span>, <span style="color:#a6e22e">smallIvan</span>.<span style="color:#a6e22e">Age</span>)
</code></pre></div><p>You would expect that age to be 40, but it's not : it's 5717318. Why? Because an uint is built by taking the required value from the Name property of John. The correct way to get a smaller Ivan is to omit the name property (observe that the third property is omitted too):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">	<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ShortIvan</span> <span style="color:#66d9ef">struct</span> {
		<span style="color:#a6e22e">_</span> <span style="color:#66d9ef">string</span>
		<span style="color:#a6e22e">Age</span> <span style="color:#66d9ef">uint</span>
	}
</code></pre></div><p>What if you violate the first rule, which states that types have to have an equal amount of properties:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">	<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">UpgradedIvan</span> <span style="color:#66d9ef">struct</span> {
		<span style="color:#75715e">//_ string // adding this at the beginning crashes
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">Name</span>    <span style="color:#66d9ef">string</span>
		<span style="color:#a6e22e">Age</span>     <span style="color:#66d9ef">uint</span>
		<span style="color:#a6e22e">Powers</span>  <span style="color:#66d9ef">uint</span>
		<span style="color:#a6e22e">Address</span> <span style="color:#66d9ef">string</span> <span style="color:#75715e">// will get filled with the Name
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">Guns</span>    <span style="color:#66d9ef">uint</span>   <span style="color:#75715e">// will get filled with Age
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//Say     string // adding yet another one will crash : &#34;bad pointer in frame&#34;
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//Data []byte // same adding this or more
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">AFloat</span> <span style="color:#66d9ef">float32</span> <span style="color:#75715e">// adding a different type seems safe
</span><span style="color:#75715e"></span>	}
	<span style="color:#a6e22e">chuckNorris</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">*</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">UpgradedIvan</span>)(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">john</span>))
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Logf</span>(<span style="color:#e6db74">&#34;Chuck Ivan : %v&#34;</span>, <span style="color:#a6e22e">chuckNorris</span>)
</code></pre></div><p>Well, it works, but with side effects : Address gets filled with same value as Name, Guns with Age and AFloat get a value of 4e-45. So, this the non-safety point that a developer should never touch. As long as we're respecting the rules, it's safe to play unsafe.</p>
<p>Also, <code>upgrading</code> John seems better (simpler) by using embedding:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">	<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">EmbeddedJohn</span> <span style="color:#66d9ef">struct</span> {
		<span style="color:#a6e22e">John</span>
		<span style="color:#a6e22e">Address</span> <span style="color:#66d9ef">string</span> <span style="color:#75715e">// will get filled with the Name ??? Weird huh
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">Guns</span>    <span style="color:#66d9ef">uint</span>   <span style="color:#75715e">// will get filled with Age ???
</span><span style="color:#75715e"></span>	}
	<span style="color:#75715e">// convert John to EmbeddedJohn
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">upgradedIvan</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">EmbeddedJohn</span>{<span style="color:#a6e22e">John</span>: <span style="color:#a6e22e">john</span>}
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Logf</span>(<span style="color:#e6db74">&#34;Upgraded Ivan : %v&#34;</span>, <span style="color:#a6e22e">upgradedIvan</span>)
</code></pre></div><p>Surely, the bellow code is dangerous if it is misused. The code speaks for itself:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestAlteredPeople</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">John</span> <span style="color:#66d9ef">struct</span> {
		<span style="color:#a6e22e">Name</span>    <span style="color:#66d9ef">string</span>
		<span style="color:#a6e22e">Age</span>     <span style="color:#66d9ef">int</span>
		<span style="color:#a6e22e">Altered</span> <span style="color:#66d9ef">bool</span>
	}

	<span style="color:#a6e22e">john</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">John</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;John&#34;</span>, <span style="color:#a6e22e">Age</span>: <span style="color:#ae81ff">30</span>, <span style="color:#a6e22e">Altered</span>: <span style="color:#66d9ef">false</span>}

	<span style="color:#a6e22e">ptrToJohn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">john</span>)
	<span style="color:#a6e22e">ptrToName</span> <span style="color:#f92672">:=</span> (<span style="color:#f92672">*</span><span style="color:#66d9ef">string</span>)(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(uintptr(<span style="color:#a6e22e">ptrToJohn</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Offsetof</span>(<span style="color:#a6e22e">john</span>.<span style="color:#a6e22e">Name</span>)))
	<span style="color:#a6e22e">ptrToAge</span> <span style="color:#f92672">:=</span> (<span style="color:#f92672">*</span><span style="color:#66d9ef">int</span>)(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(uintptr(<span style="color:#a6e22e">ptrToJohn</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Offsetof</span>(<span style="color:#a6e22e">john</span>.<span style="color:#a6e22e">Age</span>)))
	<span style="color:#a6e22e">ptrToAltered</span> <span style="color:#f92672">:=</span> (<span style="color:#f92672">*</span><span style="color:#66d9ef">bool</span>)(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(uintptr(<span style="color:#a6e22e">ptrToJohn</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Offsetof</span>(<span style="color:#a6e22e">john</span>.<span style="color:#a6e22e">Altered</span>)))

	<span style="color:#f92672">*</span><span style="color:#a6e22e">ptrToName</span> = <span style="color:#e6db74">&#34;Chuck&#34;</span>
	<span style="color:#f92672">*</span><span style="color:#a6e22e">ptrToAge</span> = <span style="color:#ae81ff">100000</span>
	<span style="color:#f92672">*</span><span style="color:#a6e22e">ptrToAltered</span> = <span style="color:#66d9ef">true</span>

	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Logf</span>(<span style="color:#e6db74">&#34;Now John is %v&#34;</span>, <span style="color:#a6e22e">john</span>)
}
</code></pre></div><h4 id="unsafe-conclusions"><code>Unsafe</code> conclusions</h4>
<p>The unsafe package is serving for Go compiler instead of Go runtime, because it has facilities for low-level programming including operations that violate the type system.</p>
<p>I would never use the above method of conversion, but investigation was needed because of what's about to be described regarding reflect.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Point</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span> <span style="color:#66d9ef">int</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Extract</span>(<span style="color:#a6e22e">ptr</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>, <span style="color:#a6e22e">size</span> <span style="color:#66d9ef">uintptr</span>) []<span style="color:#66d9ef">byte</span> {
	<span style="color:#a6e22e">out</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">size</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">out</span> {
		<span style="color:#a6e22e">out</span>[<span style="color:#a6e22e">i</span>] = <span style="color:#f92672">*</span>((<span style="color:#f92672">*</span><span style="color:#66d9ef">byte</span>)(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(uintptr(<span style="color:#a6e22e">ptr</span>) <span style="color:#f92672">+</span> uintptr(<span style="color:#a6e22e">i</span>))))
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">out</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestExtract</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Point</span>{<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>}
	<span style="color:#a6e22e">mem</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Extract</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">p</span>), <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Sizeof</span>(<span style="color:#a6e22e">p</span>))
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Logf</span>(<span style="color:#e6db74">&#34;What&#39;s the Point? %v&#34;</span>, <span style="color:#a6e22e">mem</span>)
}
</code></pre></div><p>Yes, you can extract the content of the memory, but what's the point? Well, a friend of mine (with the same name and the same passion for Golang) might find this as a useful way to hide sensitive data, by reversing the extract into carefully  filling it with secrets which comes from somewhere else.</p>
<h4 id="reflect"><code>reflect</code></h4>
<p>If you kept in mind that <code>unsafe</code> is about the compiler and not the runtime, here is the proof:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestInTheBeginning</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">r</span> <span style="color:#66d9ef">struct</span> {
		<span style="color:#a6e22e">sz</span>  <span style="color:#66d9ef">uintptr</span>
		<span style="color:#a6e22e">dt</span>  <span style="color:#66d9ef">uintptr</span>
		<span style="color:#a6e22e">_</span>   <span style="color:#66d9ef">uint32</span>
		<span style="color:#a6e22e">f</span>   <span style="color:#66d9ef">uint8</span>
		<span style="color:#a6e22e">_</span>   <span style="color:#66d9ef">uint8</span>
		<span style="color:#a6e22e">_</span>   <span style="color:#66d9ef">uint8</span>
		<span style="color:#a6e22e">knd</span> <span style="color:#66d9ef">uint8</span>
		<span style="color:#a6e22e">_</span>   <span style="color:#f92672">*</span><span style="color:#66d9ef">struct</span>{}
		<span style="color:#a6e22e">c</span>   <span style="color:#f92672">*</span><span style="color:#66d9ef">byte</span>
		<span style="color:#a6e22e">str</span> <span style="color:#66d9ef">int32</span>
		<span style="color:#a6e22e">w</span>   <span style="color:#66d9ef">int32</span>
	}
	<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">e</span> <span style="color:#66d9ef">struct</span> {
		<span style="color:#a6e22e">abracadabra</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">r</span>
	}
	<span style="color:#a6e22e">t</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">p</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#f92672">*</span><span style="color:#a6e22e">r</span> {
		<span style="color:#66d9ef">return</span> (<span style="color:#f92672">*</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">e</span>)(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">p</span>))).<span style="color:#a6e22e">abracadabra</span>
	}
	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Point</span>{<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>}
	<span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">t</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">p</span>)
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Logf</span>(<span style="color:#e6db74">&#34;After looking in the mirror : %v %v %v %v %v %v&#34;</span>, <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">sz</span>, <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">dt</span>, <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">f</span>, <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">knd</span>, <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">str</span>, <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">w</span>)
}
</code></pre></div><p>Once you run the above test, you will get the properties filled in with some values which seem pure magic. But there must be an explanation.
We didn't import <code>reflect</code> package. Also, the code is unreadable thus proving there is no magic convention like structs named in certain way or properties have some particular names.</p>
<p>So, what happen? Well, these data structures (<code>e</code> and <code>r</code> types) are <a href="https://github.com/golang/go/blob/master/src/cmd/compile/internal/gc/reflect.go">known</a> to the compiler which does it's job and at the runtime we're getting those results. To reinforce that truth, if we're replacing that <code>t</code> function with it's body <code>v :=(*(*e)(unsafe.Pointer(&amp;p))).abracadabra</code>, it won't work anymore. And even more, if we're changing the parameter type of the <code>t</code> function from <code>interface{}</code> to <code>*Point</code> it will not work as expected.</p>
<p>If you <a href="https://github.com/golang/go/blob/master/src/reflect/type.go#L297">look</a> in reflect package, you will see that <code>rtype</code> struct looks exactly the same as our <code>r</code> struct, even if the properties are named different. Same goes for <a href="https://github.com/golang/go/blob/master/src/reflect/value.go#L181"><code>emptyInterface</code></a> and our <code>e</code> struct - despite the fact that we are not using the <code>word</code> property - remember omitting properties in the unsafe example above?</p>
<h4 id="building-your-own-reflection-package">Building your own reflection package</h4>
<p>Can you build your own <code>reflect</code> package? So far my conclusion is yes, you can. At least for reading and writing the properties of structs it's quite easy.</p>
<p>However, I've encountered some problems that I want to present here. First, the (long but minimal) code (mostly copy pasted from reflect):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;testing&#34;</span>
	<span style="color:#e6db74">&#34;unsafe&#34;</span> <span style="color:#75715e">// also for linkname
</span><span style="color:#75715e"></span>)

<span style="color:#66d9ef">const</span> (
	<span style="color:#a6e22e">Invalid</span>       <span style="color:#a6e22e">Kind</span> = <span style="color:#66d9ef">iota</span>
	<span style="color:#a6e22e">Bool</span>
	<span style="color:#a6e22e">Int</span>
	<span style="color:#a6e22e">Int8</span>
	<span style="color:#a6e22e">Int16</span>
	<span style="color:#a6e22e">Int32</span>
	<span style="color:#a6e22e">Int64</span>
	<span style="color:#a6e22e">Uint</span>
	<span style="color:#a6e22e">Uint8</span>
	<span style="color:#a6e22e">Uint16</span>
	<span style="color:#a6e22e">Uint32</span>
	<span style="color:#a6e22e">Uint64</span>
	<span style="color:#a6e22e">Uintptr</span>
	<span style="color:#a6e22e">Float32</span>
	<span style="color:#a6e22e">Float64</span>
	<span style="color:#a6e22e">Complex64</span>
	<span style="color:#a6e22e">Complex128</span>
	<span style="color:#a6e22e">Array</span>
	<span style="color:#a6e22e">Chan</span>
	<span style="color:#a6e22e">Func</span>
	<span style="color:#a6e22e">Interface</span>
	<span style="color:#a6e22e">Map</span>
	<span style="color:#a6e22e">Ptr</span>
	<span style="color:#a6e22e">Slice</span>
	<span style="color:#a6e22e">String</span>
	<span style="color:#a6e22e">Struct</span>
	<span style="color:#a6e22e">UnsafePointer</span>
)

<span style="color:#66d9ef">const</span> (
	<span style="color:#a6e22e">tflagUncommon</span>  <span style="color:#a6e22e">tflag</span> = <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">0</span>
	<span style="color:#a6e22e">tflagExtraStar</span> <span style="color:#a6e22e">tflag</span> = <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>
)

<span style="color:#66d9ef">const</span> (
	<span style="color:#a6e22e">kindMask</span> = (<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">5</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
)

<span style="color:#66d9ef">type</span> (
	<span style="color:#a6e22e">Kind</span> <span style="color:#66d9ef">uint</span>
	<span style="color:#a6e22e">nameOff</span> <span style="color:#66d9ef">int32</span>
	<span style="color:#a6e22e">typeOff</span> <span style="color:#66d9ef">int32</span>
	<span style="color:#a6e22e">textOff</span> <span style="color:#66d9ef">int32</span>
	<span style="color:#a6e22e">tflag</span> <span style="color:#66d9ef">uint8</span>
	<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">struct</span> {
		<span style="color:#a6e22e">bytes</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">byte</span>
	}
	<span style="color:#a6e22e">uncommonType</span> <span style="color:#66d9ef">struct</span> {
		<span style="color:#a6e22e">pkgPath</span> <span style="color:#a6e22e">nameOff</span>
		<span style="color:#a6e22e">mcount</span>  <span style="color:#66d9ef">uint16</span>
		<span style="color:#a6e22e">_</span>       <span style="color:#66d9ef">uint16</span>
		<span style="color:#a6e22e">moff</span>    <span style="color:#66d9ef">uint32</span>
		<span style="color:#a6e22e">_</span>       <span style="color:#66d9ef">uint32</span>
	}
	<span style="color:#a6e22e">rtype</span> <span style="color:#66d9ef">struct</span> {
		<span style="color:#a6e22e">size</span>       <span style="color:#66d9ef">uintptr</span>
		<span style="color:#a6e22e">ptrdata</span>    <span style="color:#66d9ef">uintptr</span>
		<span style="color:#a6e22e">hash</span>       <span style="color:#66d9ef">uint32</span>
		<span style="color:#a6e22e">tflag</span>      <span style="color:#a6e22e">tflag</span>
		<span style="color:#a6e22e">align</span>      <span style="color:#66d9ef">uint8</span>
		<span style="color:#a6e22e">fieldAlign</span> <span style="color:#66d9ef">uint8</span>
		<span style="color:#a6e22e">kind</span>       <span style="color:#66d9ef">uint8</span>
		<span style="color:#a6e22e">alg</span>        <span style="color:#f92672">*</span><span style="color:#a6e22e">typeAlg</span>
		<span style="color:#a6e22e">gcdata</span>     <span style="color:#f92672">*</span><span style="color:#66d9ef">byte</span>
		<span style="color:#a6e22e">str</span>        <span style="color:#a6e22e">nameOff</span>
		<span style="color:#a6e22e">ptrToThis</span>  <span style="color:#a6e22e">typeOff</span>
	}
	<span style="color:#a6e22e">typeAlg</span> <span style="color:#66d9ef">struct</span> {
		<span style="color:#a6e22e">hash</span>  <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>, <span style="color:#66d9ef">uintptr</span>) <span style="color:#66d9ef">uintptr</span>
		<span style="color:#a6e22e">equal</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>, <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>) <span style="color:#66d9ef">bool</span>
	}
	<span style="color:#a6e22e">method</span> <span style="color:#66d9ef">struct</span> {
		<span style="color:#a6e22e">name</span> <span style="color:#a6e22e">nameOff</span>
		<span style="color:#a6e22e">mtyp</span> <span style="color:#a6e22e">typeOff</span>
		<span style="color:#a6e22e">ifn</span>  <span style="color:#a6e22e">textOff</span>
		<span style="color:#a6e22e">tfn</span>  <span style="color:#a6e22e">textOff</span>
	}
	<span style="color:#a6e22e">structField</span> <span style="color:#66d9ef">struct</span> {
		<span style="color:#a6e22e">name</span>       <span style="color:#a6e22e">name</span>
		<span style="color:#a6e22e">typ</span>        <span style="color:#f92672">*</span><span style="color:#a6e22e">rtype</span>
		<span style="color:#a6e22e">offsetAnon</span> <span style="color:#66d9ef">uintptr</span>
	}
	<span style="color:#a6e22e">structType</span> <span style="color:#66d9ef">struct</span> {
		<span style="color:#a6e22e">rtype</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">reflect:&#34;struct&#34;</span><span style="color:#e6db74">`</span>
		<span style="color:#a6e22e">pkgPath</span> <span style="color:#a6e22e">name</span>
		<span style="color:#a6e22e">fields</span>  []<span style="color:#a6e22e">structField</span>
	}
	<span style="color:#a6e22e">emptyInterface</span> <span style="color:#66d9ef">struct</span> {
		<span style="color:#a6e22e">typ</span>  <span style="color:#f92672">*</span><span style="color:#a6e22e">rtype</span>
		<span style="color:#a6e22e">word</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>
	}
	<span style="color:#a6e22e">stringHeader</span> <span style="color:#66d9ef">struct</span> {
		<span style="color:#a6e22e">Data</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>
		<span style="color:#a6e22e">Len</span>  <span style="color:#66d9ef">int</span>
	}
	<span style="color:#a6e22e">ptrType</span> <span style="color:#66d9ef">struct</span> {
		<span style="color:#a6e22e">rtype</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">reflect:&#34;ptr&#34;</span><span style="color:#e6db74">`</span>
		<span style="color:#a6e22e">elem</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rtype</span> <span style="color:#75715e">// pointer element (pointed at) type
</span><span style="color:#75715e"></span>	}
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">resolveReflectName</span>(<span style="color:#a6e22e">n</span> <span style="color:#a6e22e">name</span>) <span style="color:#a6e22e">nameOff</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">nameOff</span>(<span style="color:#a6e22e">addReflectOff</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">n</span>.<span style="color:#a6e22e">bytes</span>)))
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">p</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>, <span style="color:#a6e22e">x</span> <span style="color:#66d9ef">uintptr</span>) <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(uintptr(<span style="color:#a6e22e">p</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">x</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">fnv1</span>(<span style="color:#a6e22e">x</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">list</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">byte</span>) <span style="color:#66d9ef">uint32</span> {
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">b</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">list</span> {
		<span style="color:#a6e22e">x</span> = <span style="color:#a6e22e">x</span><span style="color:#f92672">*</span><span style="color:#ae81ff">16777619</span> ^ uint32(<span style="color:#a6e22e">b</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">x</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">rtypeOff</span>(<span style="color:#a6e22e">section</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>, <span style="color:#a6e22e">off</span> <span style="color:#66d9ef">int32</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">rtype</span> {
	<span style="color:#66d9ef">return</span> (<span style="color:#f92672">*</span><span style="color:#a6e22e">rtype</span>)(<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">section</span>, uintptr(<span style="color:#a6e22e">off</span>)))
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">typesByString</span>(<span style="color:#a6e22e">s</span> <span style="color:#66d9ef">string</span>) []<span style="color:#f92672">*</span><span style="color:#a6e22e">rtype</span> {
	<span style="color:#a6e22e">sections</span>, <span style="color:#a6e22e">offset</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">typelinks</span>()
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ret</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">rtype</span>

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">offsI</span>, <span style="color:#a6e22e">offs</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">offset</span> {
		<span style="color:#a6e22e">section</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sections</span>[<span style="color:#a6e22e">offsI</span>]
		<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">j</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>, len(<span style="color:#a6e22e">offs</span>)
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">j</span> {
			<span style="color:#a6e22e">h</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">+</span> (<span style="color:#a6e22e">j</span><span style="color:#f92672">-</span><span style="color:#a6e22e">i</span>)<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>
			<span style="color:#66d9ef">if</span> !(<span style="color:#a6e22e">rtypeOff</span>(<span style="color:#a6e22e">section</span>, <span style="color:#a6e22e">offs</span>[<span style="color:#a6e22e">h</span>]).<span style="color:#a6e22e">String</span>() <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">s</span>) {
				<span style="color:#a6e22e">i</span> = <span style="color:#a6e22e">h</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
			} <span style="color:#66d9ef">else</span> {
				<span style="color:#a6e22e">j</span> = <span style="color:#a6e22e">h</span>
			}
		}
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">i</span>; <span style="color:#a6e22e">j</span> &lt; len(<span style="color:#a6e22e">offs</span>); <span style="color:#a6e22e">j</span><span style="color:#f92672">++</span> {
			<span style="color:#a6e22e">typ</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rtypeOff</span>(<span style="color:#a6e22e">section</span>, <span style="color:#a6e22e">offs</span>[<span style="color:#a6e22e">j</span>])
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">typ</span>.<span style="color:#a6e22e">String</span>() <span style="color:#f92672">!=</span> <span style="color:#a6e22e">s</span> {
				<span style="color:#66d9ef">break</span>
			}
			<span style="color:#a6e22e">ret</span> = append(<span style="color:#a6e22e">ret</span>, <span style="color:#a6e22e">typ</span>)
		}
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ret</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">newName</span>(<span style="color:#a6e22e">n</span>, <span style="color:#a6e22e">tag</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">exported</span> <span style="color:#66d9ef">bool</span>) <span style="color:#a6e22e">name</span> {
	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">n</span>) &gt; <span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">16</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> {
		panic(<span style="color:#e6db74">&#34;reflect.nameFrom: name too long: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">n</span>)
	}
	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">tag</span>) &gt; <span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">16</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> {
		panic(<span style="color:#e6db74">&#34;reflect.nameFrom: tag too long: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">tag</span>)
	}

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">bits</span> <span style="color:#66d9ef">byte</span>
	<span style="color:#a6e22e">l</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> len(<span style="color:#a6e22e">n</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">exported</span> {
		<span style="color:#a6e22e">bits</span> <span style="color:#f92672">|=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">0</span>
	}
	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">tag</span>) &gt; <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">l</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> len(<span style="color:#a6e22e">tag</span>)
		<span style="color:#a6e22e">bits</span> <span style="color:#f92672">|=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>
	}

	<span style="color:#a6e22e">b</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">l</span>)
	<span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">0</span>] = <span style="color:#a6e22e">bits</span>
	<span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">1</span>] = uint8(len(<span style="color:#a6e22e">n</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">8</span>)
	<span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">2</span>] = uint8(len(<span style="color:#a6e22e">n</span>))
	copy(<span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">3</span>:], <span style="color:#a6e22e">n</span>)
	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">tag</span>) &gt; <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">tb</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">3</span><span style="color:#f92672">+</span>len(<span style="color:#a6e22e">n</span>):]
		<span style="color:#a6e22e">tb</span>[<span style="color:#ae81ff">0</span>] = uint8(len(<span style="color:#a6e22e">tag</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">8</span>)
		<span style="color:#a6e22e">tb</span>[<span style="color:#ae81ff">1</span>] = uint8(len(<span style="color:#a6e22e">tag</span>))
		copy(<span style="color:#a6e22e">tb</span>[<span style="color:#ae81ff">2</span>:], <span style="color:#a6e22e">tag</span>)
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">name</span>{<span style="color:#a6e22e">bytes</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">0</span>]}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">n</span> <span style="color:#a6e22e">name</span>) <span style="color:#a6e22e">isExported</span>() <span style="color:#66d9ef">bool</span> {
	<span style="color:#66d9ef">return</span> (<span style="color:#f92672">*</span><span style="color:#a6e22e">n</span>.<span style="color:#a6e22e">bytes</span>)<span style="color:#f92672">&amp;</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">0</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">n</span> <span style="color:#a6e22e">name</span>) <span style="color:#a6e22e">name</span>() (<span style="color:#a6e22e">s</span> <span style="color:#66d9ef">string</span>) {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">n</span>.<span style="color:#a6e22e">bytes</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#e6db74">&#34;no name&#34;</span>)
	}
	<span style="color:#a6e22e">b</span> <span style="color:#f92672">:=</span> (<span style="color:#f92672">*</span>[<span style="color:#ae81ff">4</span>]<span style="color:#66d9ef">byte</span>)(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">n</span>.<span style="color:#a6e22e">bytes</span>))

	<span style="color:#a6e22e">hdr</span> <span style="color:#f92672">:=</span> (<span style="color:#f92672">*</span><span style="color:#a6e22e">stringHeader</span>)(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">s</span>))
	<span style="color:#a6e22e">hdr</span>.<span style="color:#a6e22e">Data</span> = <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">3</span>])
	<span style="color:#a6e22e">hdr</span>.<span style="color:#a6e22e">Len</span> = int(<span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">1</span>])<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">8</span> | int(<span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">2</span>])
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rtype</span>) <span style="color:#a6e22e">nameOff</span>(<span style="color:#a6e22e">off</span> <span style="color:#a6e22e">nameOff</span>) <span style="color:#a6e22e">name</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">name</span>{(<span style="color:#f92672">*</span><span style="color:#66d9ef">byte</span>)(<span style="color:#a6e22e">resolveNameOff</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">t</span>), int32(<span style="color:#a6e22e">off</span>)))}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rtype</span>) <span style="color:#a6e22e">typeOff</span>(<span style="color:#a6e22e">off</span> <span style="color:#a6e22e">typeOff</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">rtype</span> {
	<span style="color:#66d9ef">return</span> (<span style="color:#f92672">*</span><span style="color:#a6e22e">rtype</span>)(<span style="color:#a6e22e">resolveTypeOff</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">t</span>), int32(<span style="color:#a6e22e">off</span>)))
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rtype</span>) <span style="color:#a6e22e">Kind</span>() <span style="color:#a6e22e">Kind</span> { <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Kind</span>(<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">kind</span> <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">kindMask</span>) }

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rtype</span>) <span style="color:#a6e22e">String</span>() <span style="color:#66d9ef">string</span> {
	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">nameOff</span>(<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">str</span>).<span style="color:#a6e22e">name</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">tflag</span><span style="color:#f92672">&amp;</span><span style="color:#a6e22e">tflagExtraStar</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>[<span style="color:#ae81ff">1</span>:]
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">uncommonType</span>) <span style="color:#a6e22e">methods</span>() []<span style="color:#a6e22e">method</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">mcount</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
		panic(<span style="color:#e6db74">&#34;zero methods&#34;</span>)
	}
	<span style="color:#66d9ef">return</span> (<span style="color:#f92672">*</span>[<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">16</span>]<span style="color:#a6e22e">method</span>)(<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">t</span>), uintptr(<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">moff</span>)))[:<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">mcount</span>:<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">mcount</span>]
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rtype</span>) <span style="color:#a6e22e">uncommon</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">uncommonType</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">tflag</span><span style="color:#f92672">&amp;</span><span style="color:#a6e22e">tflagUncommon</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Kind</span>() <span style="color:#f92672">!=</span> <span style="color:#a6e22e">Struct</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Kind</span>() <span style="color:#f92672">!=</span> <span style="color:#a6e22e">Ptr</span> {
		panic(<span style="color:#e6db74">&#34;not struct or pointer&#34;</span>)
	}
	<span style="color:#a6e22e">ptrToT</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">t</span>)

	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Kind</span>() {
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Struct</span>:
		<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">u</span> <span style="color:#66d9ef">struct</span> {
			<span style="color:#a6e22e">structType</span>
			<span style="color:#a6e22e">u</span> <span style="color:#a6e22e">uncommonType</span>
		}
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">u</span>)(<span style="color:#a6e22e">ptrToT</span>).<span style="color:#a6e22e">u</span>
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Ptr</span>:
		<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">u</span> <span style="color:#66d9ef">struct</span> {
			<span style="color:#a6e22e">ptrType</span>
			<span style="color:#a6e22e">u</span> <span style="color:#a6e22e">uncommonType</span>
		}
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">u</span>)(<span style="color:#a6e22e">ptrToT</span>).<span style="color:#a6e22e">u</span>
	<span style="color:#66d9ef">default</span>:
		<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">u</span> <span style="color:#66d9ef">struct</span> {
			<span style="color:#a6e22e">rtype</span>
			<span style="color:#a6e22e">u</span> <span style="color:#a6e22e">uncommonType</span>
		}
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">u</span>)(<span style="color:#a6e22e">ptrToT</span>).<span style="color:#a6e22e">u</span>
	}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rtype</span>) <span style="color:#a6e22e">exportedMethods</span>() []<span style="color:#a6e22e">method</span> {
	<span style="color:#a6e22e">ut</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">uncommon</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ut</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}
	<span style="color:#a6e22e">allMethods</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ut</span>.<span style="color:#a6e22e">methods</span>()
	<span style="color:#a6e22e">allExported</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">true</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">method</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">allMethods</span> {
		<span style="color:#a6e22e">name</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">nameOff</span>(<span style="color:#a6e22e">method</span>.<span style="color:#a6e22e">name</span>)
		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">name</span>.<span style="color:#a6e22e">isExported</span>() {
			<span style="color:#a6e22e">allExported</span> = <span style="color:#66d9ef">false</span>
			<span style="color:#66d9ef">break</span>
		}
	}
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">methods</span> []<span style="color:#a6e22e">method</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">allExported</span> {
		<span style="color:#a6e22e">methods</span> = <span style="color:#a6e22e">allMethods</span>
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#a6e22e">methods</span> = make([]<span style="color:#a6e22e">method</span>, <span style="color:#ae81ff">0</span>, len(<span style="color:#a6e22e">allMethods</span>))
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">allMethods</span> {
			<span style="color:#a6e22e">name</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">nameOff</span>(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">name</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">name</span>.<span style="color:#a6e22e">isExported</span>() {
				<span style="color:#a6e22e">methods</span> = append(<span style="color:#a6e22e">methods</span>, <span style="color:#a6e22e">m</span>)
			}
		}
		<span style="color:#a6e22e">methods</span> = <span style="color:#a6e22e">methods</span>[:len(<span style="color:#a6e22e">methods</span>):len(<span style="color:#a6e22e">methods</span>)]
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">methods</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rtype</span>) <span style="color:#a6e22e">ptrTo</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">rtype</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">ptrToThis</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">typeOff</span>(<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">ptrToThis</span>)
	}
	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;*&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">String</span>()
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">tt</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">typesByString</span>(<span style="color:#a6e22e">s</span>) {
		<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> (<span style="color:#f92672">*</span><span style="color:#a6e22e">ptrType</span>)(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">tt</span>))
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">elem</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">t</span> {
			<span style="color:#66d9ef">continue</span>
		}
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">rtype</span>
	}
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">iptr</span> <span style="color:#66d9ef">interface</span>{} = (<span style="color:#f92672">*</span><span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>)(<span style="color:#66d9ef">nil</span>)
	<span style="color:#a6e22e">prototype</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">*</span>(<span style="color:#f92672">*</span><span style="color:#f92672">*</span><span style="color:#a6e22e">ptrType</span>)(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">iptr</span>))
	<span style="color:#a6e22e">pp</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">prototype</span>
	<span style="color:#a6e22e">pp</span>.<span style="color:#a6e22e">str</span> = <span style="color:#a6e22e">resolveReflectName</span>(<span style="color:#a6e22e">newName</span>(<span style="color:#a6e22e">s</span>, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#66d9ef">false</span>))
	<span style="color:#a6e22e">pp</span>.<span style="color:#a6e22e">ptrToThis</span> = <span style="color:#ae81ff">0</span>
	<span style="color:#a6e22e">pp</span>.<span style="color:#a6e22e">hash</span> = <span style="color:#a6e22e">fnv1</span>(<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">hash</span>, <span style="color:#e6db74">&#39;*&#39;</span>)
	<span style="color:#a6e22e">pp</span>.<span style="color:#a6e22e">elem</span> = <span style="color:#a6e22e">t</span>
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pp</span>.<span style="color:#a6e22e">rtype</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TypeOf</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#f92672">*</span><span style="color:#a6e22e">rtype</span> {
	<span style="color:#66d9ef">return</span> (<span style="color:#f92672">*</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">emptyInterface</span>)(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">i</span>))).<span style="color:#a6e22e">typ</span>.<span style="color:#a6e22e">ptrTo</span>()
}
</code></pre></div><p>Of course, to run tests, we have to create an <code>empty.s</code> file in the same folder and to add the linkname directives for two functions:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#75715e">//go:linkname resolveTypeOff runtime.resolveTypeOff
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">resolveTypeOff</span>(<span style="color:#a6e22e">rtype</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>, <span style="color:#a6e22e">off</span> <span style="color:#66d9ef">int32</span>) <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>

<span style="color:#75715e">//go:linkname resolveNameOff runtime.resolveNameOff
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">resolveNameOff</span>(<span style="color:#a6e22e">ptrInModule</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>, <span style="color:#a6e22e">off</span> <span style="color:#66d9ef">int32</span>) <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>

<span style="color:#75715e">//go:linkname typelinks reflect.typelinks
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">typelinks</span>() (<span style="color:#a6e22e">sections</span> []<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>, <span style="color:#a6e22e">offset</span> [][]<span style="color:#66d9ef">int32</span>)

<span style="color:#75715e">//go:linkname addReflectOff reflect.addReflectOff
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">addReflectOff</span>(<span style="color:#a6e22e">ptr</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>) <span style="color:#66d9ef">int32</span>

</code></pre></div><p>On the <code>Point</code> struct declared above, we're adding the followings:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#a6e22e">Point</span>) <span style="color:#a6e22e">AnotherMethod</span>(<span style="color:#a6e22e">scale</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">int</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#a6e22e">Point</span>) <span style="color:#a6e22e">Dist</span>(<span style="color:#a6e22e">scale</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">int</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">x</span><span style="color:#f92672">*</span><span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">x</span><span style="color:#f92672">*</span><span style="color:#a6e22e">scale</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">y</span><span style="color:#f92672">*</span><span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">y</span><span style="color:#f92672">*</span><span style="color:#a6e22e">scale</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#a6e22e">Point</span>) <span style="color:#a6e22e">NoArgs</span>() {
	println(<span style="color:#e6db74">&#34;NoArgs called.&#34;</span>)
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#a6e22e">Point</span>) <span style="color:#a6e22e">TotalDist</span>(<span style="color:#a6e22e">points</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">Point</span>) <span style="color:#66d9ef">int</span> {
	<span style="color:#a6e22e">tot</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">q</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">points</span> {
		<span style="color:#a6e22e">dx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">q</span>.<span style="color:#a6e22e">x</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">x</span>
		<span style="color:#a6e22e">dy</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">q</span>.<span style="color:#a6e22e">y</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">y</span>
		<span style="color:#a6e22e">tot</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">dx</span><span style="color:#f92672">*</span><span style="color:#a6e22e">dx</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">dy</span><span style="color:#f92672">*</span><span style="color:#a6e22e">dy</span>
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">tot</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#a6e22e">Point</span>) <span style="color:#a6e22e">NoArgsButReturn</span>() <span style="color:#66d9ef">string</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;something&#34;</span>
}
</code></pre></div><p>And finally, the test :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestMethod</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Point</span>{<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>}
	<span style="color:#a6e22e">pType</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">TypeOf</span>(<span style="color:#a6e22e">p</span>)
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Logf</span>(<span style="color:#e6db74">&#34;%v&#34;</span>, <span style="color:#a6e22e">pType</span>)
	<span style="color:#a6e22e">methods</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pType</span>.<span style="color:#a6e22e">exportedMethods</span>()
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">idx</span>, <span style="color:#a6e22e">method</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">methods</span> {
		<span style="color:#a6e22e">name</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pType</span>.<span style="color:#a6e22e">nameOff</span>(<span style="color:#a6e22e">method</span>.<span style="color:#a6e22e">name</span>)
		<span style="color:#a6e22e">typ</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pType</span>.<span style="color:#a6e22e">typeOff</span>(<span style="color:#a6e22e">method</span>.<span style="color:#a6e22e">mtyp</span>)
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Logf</span>(<span style="color:#e6db74">&#34;%d : Method %q %v %v %v\n&#34;</span>, <span style="color:#a6e22e">idx</span>, <span style="color:#a6e22e">name</span>.<span style="color:#a6e22e">name</span>(), <span style="color:#a6e22e">typ</span>, <span style="color:#a6e22e">method</span>.<span style="color:#a6e22e">tfn</span>, <span style="color:#a6e22e">method</span>.<span style="color:#a6e22e">ifn</span>)
	}
}
</code></pre></div><p>When we run this test, we're going to see that the methods signature are reported differently than what we've declared. This means we are not doing something that <code>reflect</code> package does.</p>
<p>Our version of TypeOf function doesn't return an interface and also, that interface is built by calling toPtr() method of the rType. However, with that code added, the problem still doesn't get fixed.</p>
<p>Adding the following code, fixes the test (the signatures are correct).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">	<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">dummy</span> <span style="color:#66d9ef">struct</span>{}
	<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">d</span> <span style="color:#a6e22e">dummy</span>) <span style="color:#a6e22e">A</span>() {}
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">TypeOf</span>(<span style="color:#a6e22e">dummy</span>{}).<span style="color:#a6e22e">Method</span>(<span style="color:#ae81ff">0</span>)
</code></pre></div><p>Seems the function <code>func addReflectOff(ptr unsafe.Pointer) int32</code> which is implemented in the runtime package gets called from <code>reflect</code> package which creates <a href="https://github.com/golang/go/blob/34db5f0c4d80b8fe3fb4b5be90efd9ee92bd1d4d/src/runtime/type.go#L147">reflectOffs structs</a> for later lookups. We need to force the compiler to allow us to use the same functions as reflect does. Since we're not using reflect anywhere, dead code removal does not allow us to initialize properly - so we need to force it.</p>
<p>Indeed, we're importing reflect to write our own reflect, but we're not using it in other than dumb init.</p>
<p>In the larger version (my own version of reflect), all Value.Call() tests were failing in a segmentation fault, with a reason (method types were zero) - the code being the same as in reflect package. For this reason I've presented you with this small test and it's conclusions.</p>
<h4 id="conclusion">Conclusion</h4>
<p>It took me four days to learn the internals and modify the reflect package for my needs, but in the end I've done it and later I will probably integrate it into the <a href="https://github.com/badu/reflector">reflector</a> package.</p>
<p>Probably the lack of documentation made things harder to understand and follow. Probably some things are never meant to be - that - public, due to some sort of programming language politics. Who knows but mostly who cares?</p>
<p>I encourage you to take my advice and break things so you can learn how they work, how other developers solved problems that you cannot think about while just reading the code.</p>
</div>
    


    <h4 class="page-header">Related</h4>
 <div class="item">



  
    <h4><a href="/post/interviewing-go-developer-part-2/">Interview Questions for Go Developer Position - Part II</a></h4>
    <h5>Measuring And Classifying Go Developer Knowledge</h5>
    
      <h5>Published on December 7, 2018</h5>
    
 <kbd class="item-tag">Go</kbd>  <kbd class="item-tag">Developer</kbd>  <kbd class="item-tag">Interview</kbd> 
<p>About 3 minutes of reading.</p>
</div>
  <div class="item">



  
    <h4><a href="/post/changing-perspective/">Changing Perspective</a></h4>
    <h5>Changing Perspective Might Help You Understand</h5>
    
      <h5>Published on November 20, 2018</h5>
    
 <kbd class="item-tag">Go</kbd>  <kbd class="item-tag">Channels</kbd>  <kbd class="item-tag">Grouping Methods</kbd> 
<p>About 7 minutes of reading.</p>
</div>
  <div class="item">



  
    <h4><a href="/post/interviewing-go-developer-part-1/">Interview Questions for Go Developer Position</a></h4>
    <h5>Measuring And Classifying Go Developer Knowledge</h5>
    
      <h5>Published on November 18, 2018</h5>
    
 <kbd class="item-tag">Go</kbd>  <kbd class="item-tag">Developer</kbd>  <kbd class="item-tag">Interview</kbd> 
<p>About 7 minutes of reading.</p>
</div>
 


    <h4 class="page-header">Comments</h4>
<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "recency-bias" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</main>
<footer>
    <p class="copyright text-muted"> Recency Bias &copy; 2018
        - Powered by <a href="https://gohugo.io">Hugo</a>.</p>
</footer>
</body>
</html>

